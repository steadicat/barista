<!DOCTYPE html>  <html> <head>   <title>develop.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               develop.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Static sites nowadays are not built with HTML, CSS, and Javascript,
like grandma used to do it. These days, we have
<a href="http://haml-lang.org/">HAML</a>, <a href="http://compass-style.org/">Compass</a>,
and <a href="http://coffeescript.org/">CoffeeScript</a>. They are obviously
much more awesome, because they all use significant
whitespace. Except they have another thing in common: they need to
be pre-processed into something grandma's browser can understand.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Let me tell you, that's a PITA. Because running a command to compile
on each change is not an option. If grandma used to be able to make
a change and refresh, I want to be able to do it too.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The usual solution is to run a script that watches files for
changes, and compiles them on the fly. Except I'm way faster than
the script. By the time the script is done compiling, I've already
refreshed the browser 27 times and I'm wondering why my change had
no effect.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>We need a better solution. And the solution is right here. That's
right, it's a development web server. Like the one Django has. But
for static files.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Configuration</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This is where your static files live.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">STATIC</span> <span class="o">=</span> <span class="s1">&#39;static&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This is the port the development server will listen on.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">PORT</span> <span class="o">=</span> <span class="mi">5678</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>Set up</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;path&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>HTTP handlers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>This is where it all starts, when an HTTP request comes in. The
request is dispatched to one of the handlers below based on the type
of file that is being requested.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">log</span> <span class="s2">&quot;#{req.method} #{req.url}&quot;</span>
    <span class="k">for</span> <span class="p">[</span><span class="nx">rule</span><span class="p">,</span> <span class="nx">handler</span><span class="p">]</span> <span class="k">in</span> <span class="nx">handlers</span>
        <span class="nx">matches</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span> <span class="nx">rule</span>
        <span class="k">if</span> <span class="nx">matches</span>
            <span class="k">return</span> <span class="nx">handler</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">res</span>
    <span class="nx">log</span> <span class="s1">&#39;Not found!&#39;</span>
    <span class="nx">notFound</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If the request is for a <strong>CSS</strong> file, first check to see if a
corresponding SASS file exists.  If it does, compile it and return
it, otherwise simply return the CSS file.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">handleCss</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">pickFirst</span> <span class="s2">&quot;#{STATIC}/#{file}.sass&quot;</span><span class="p">,</span> <span class="s2">&quot;#{STATIC}/#{file}.css&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">error</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">notFound</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;.sass&#39;</span>
            <span class="nx">compileSass</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="nx">write</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="s1">&#39;text/css&#39;</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="nx">writeFile</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;text/css&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Similarly, if a request is for an <strong>HTML</strong> file, look for a
corresponding HAML file first, otherwise just look for the HTML
file. If neither is found, try treating the path as a directory, and
look for an index file within it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">handleHtml</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">file</span> <span class="o">=</span> <span class="nx">stripExt</span> <span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span>
    <span class="nx">pickFirst</span> <span class="s2">&quot;#{STATIC}/#{file}.haml&quot;</span><span class="p">,</span> <span class="s2">&quot;#{STATIC}/#{file}.html&quot;</span><span class="p">,</span> <span class="s2">&quot;#{STATIC}/#{file}/index.haml&quot;</span><span class="p">,</span> <span class="s2">&quot;#{STATIC}/#{file}/index.html&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">error</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">notFound</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;.haml&#39;</span>
            <span class="nx">compileHaml</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="nx">write</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="nx">writeFile</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If the request is for a <strong>Javascript</strong> file, simply call <code>loadJs</code>, which
will take care of looking for CoffeeScript or Javascript files, and
process the require directives recursively.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">handleJs</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">loadJs</span> <span class="s2">&quot;#{STATIC}/#{file}&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="nx">write</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="s1">&#39;application/x-javascript&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Anything else is probably just a static file. Simply spit out its
contents as they are.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">handleStatic</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="s2">&quot;#{STATIC}/#{file}&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="nx">write</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>These are the regular expressions used to decide which handler to
dispatch to. Note that extensions for html files are optional.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">handlers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="sr">/^\/((.+\/)*.+)\.css/</span><span class="p">,</span> <span class="nx">handleCss</span><span class="p">]</span>
    <span class="p">[</span><span class="sr">/^\/((.+\/)*.+)\.js/</span><span class="p">,</span> <span class="nx">handleJs</span><span class="p">]</span>
    <span class="p">[</span><span class="sr">/^\/((.+\/)*[^.]*)(\.html)?/</span><span class="p">,</span> <span class="nx">handleHtml</span><span class="p">]</span>
    <span class="p">[</span><span class="sr">/^\/((.+\/)*[^.]*\.[^.]*)/</span><span class="p">,</span> <span class="nx">handleStatic</span><span class="p">]</span>
<span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Javascript/CoffeeScript</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>These functions allow for compiling CoffeeScript files on the fly
and also merging them into one by following the chain of includes.</p>

<p>The syntax for includes is:</p>

<pre><code>### require "subdir/file" ###
</code></pre>

<p>for CoffeScript, and</p>

<pre><code>/* require "subdir/file" */
</code></pre>

<p>for Javascript.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Conveniently, the first one compiles into the second one, so we can
simply convert CoffeeScripts into JS first, then look for the JS
require comments.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">REQUIRE_RULE</span> <span class="o">=</span> <span class="sr">/\/\*\s+require\s+[&quot;&#39;](.+)[&#39;&quot;]\s+\*\//g</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>We start by looking for the first file that exists that corresponds
to the given module name. Look for a <code>.coffee</code> file first, then for
a <code>.js</code>. Unless CoffeeScript is not installed, in which case only
look for <code>.js</code> files.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">loadJs</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">choices</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">coffee</span> <span class="k">then</span> <span class="p">[</span><span class="s2">&quot;#{file}.coffee&quot;</span><span class="p">,</span> <span class="s2">&quot;#{file}.js&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;#{file}.js&quot;</span><span class="p">]</span>
    <span class="nx">pickFirst</span> <span class="nx">choices</span><span class="p">...,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;.coffee&#39;</span>
            <span class="nx">compileCoffee</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">callback</span>
        <span class="k">else</span>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="nx">processRequires</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If the files are CoffeeScript files, compile them by calling back to
the <code>coffee</code> module. Otherwise, go straight to the processing of
require directives.</p>

<p>By the way, here we do something smart with any exceptions. Instead
of printing out in the log file, we return valid JS that puts a
nicely formatted error message right in the page that requested this
JS file.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">coffee</span> <span class="o">=</span> <span class="k">try</span> <span class="nx">require</span> <span class="s1">&#39;coffee-script&#39;</span> <span class="k">catch</span> <span class="nx">e</span> <span class="k">then</span> <span class="kc">no</span>

<span class="nx">compileCoffee</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">try</span>
            <span class="nx">processRequires</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">coffee</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">content</span><span class="p">),</span> <span class="nx">callback</span>
        <span class="k">catch</span> <span class="nx">error</span>
            <span class="nx">stack</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">,</span> <span class="s1">&#39;\\n\\\n&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span> <span class="s1">&#39;\\&quot;&#39;</span><span class="p">)</span>
            <span class="nx">callback</span> <span class="nx">ok</span><span class="p">,</span> <span class="s2">&quot;document.body.innerHTML = \&quot;&lt;h3 style=&#39;color: #c30&#39;&gt;Error in #{file}&lt;/h1&gt;&lt;pre&gt;#{stack}&lt;/pre&gt;\&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>This does the actual replacing of include directives with the
content of the files. It uses <code>asyncReplace</code> to call recursively
back to the asynchronous function <code>loadJs</code> for every include
directive found.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">processRequires</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">other</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="nx">loadJs</span> <span class="nx">other</span><span class="p">,</span> <span class="nx">cb</span>
    <span class="nx">asyncReplace</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">REQUIRE_RULE</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h2>CSS/SASS/Compass</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Compiling Compass/SASS files into CSS files is easy. Unfortunately
the only way to do it is to spawn a new process to call the Ruby
<code>compass</code> command. We then have to read from the CSS file it outputs
to disk.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">compileSass</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">dir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">file</span>
    <span class="nx">target</span> <span class="o">=</span> <span class="s2">&quot;#{dir}/#{path.basename(file, &#39;.sass&#39;)}.css&quot;</span>
    <span class="nx">exec</span> <span class="s2">&quot;compass compile --sass-dir #{dir} --css-dir #{dir} --images-dir #{STATIC} -s compressed --relative-assets #{file}&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">(</span><span class="nx">output</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">log</span> <span class="nx">output</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h2>HTML/HAML</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Processing HAML is very similar, except there is a Node.js version
of HAML. Try to use that if it's installed, otherwise call out to
the Ruby <code>haml</code> command. Personally I prefer the Ruby version anyway
since it's more complete, more up to date, and it supports Markdown,
and even advanced Markdown with Maruku.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">haml</span> <span class="o">=</span> <span class="k">try</span> <span class="nx">require</span> <span class="s1">&#39;hamljs&#39;</span> <span class="k">catch</span> <span class="nx">e</span> <span class="k">then</span> <span class="kc">no</span>

<span class="nx">compileHaml</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">dir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">file</span>
    <span class="nx">target</span> <span class="o">=</span> <span class="s2">&quot;#{dir}/#{path.basename(file, &#39;.haml&#39;)}.html&quot;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">haml</span>
            <span class="nx">haml</span><span class="p">.</span><span class="nx">render</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">callback</span>
        <span class="k">else</span>
            <span class="nx">exec</span> <span class="s1">&#39;haml -f html5&#39;</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2>Helpers</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Alias <code>null</code> to <code>ok</code> so you can write <code>callback ok, result</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">ok</span> <span class="o">=</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>A function with a short name for logging and debugging.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">log</span> <span class="o">=</span> <span class="p">(</span><span class="nx">args</span><span class="p">...)</span> <span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span>
        <span class="k">if</span> <span class="nx">arg</span> <span class="k">instanceof</span> <span class="nb">Error</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">stack</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">arg</span> <span class="o">!=</span> <span class="kc">undefined</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">arg</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Wraps a <code>callback</code> function with another one that takes care of
error handling by forwarding the error straight up the callback
chain.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">err</span> <span class="o">=</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="nx">err</span>
                <span class="nx">callback</span> <span class="nx">err</span>
            <span class="k">else</span>
                <span class="nx">f</span> <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Find the first file in the list of arguments that exists.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">pickFirst</span> <span class="o">=</span> <span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">rest</span><span class="p">...,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">exists</span> <span class="nx">first</span><span class="p">,</span> <span class="p">(</span><span class="nx">exists</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">exists</span>
            <span class="nx">callback</span> <span class="nx">ok</span><span class="p">,</span> <span class="nx">first</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="nx">callback</span> <span class="s2">&quot;not_found&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">length</span>
            <span class="nx">pickFirst</span> <span class="nx">rest</span><span class="p">...,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Write a file back to the HTTP response.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">writeFile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">file</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="nx">write</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Write a string back to the HTTP response.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">write</span> <span class="o">=</span> <span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s2">&quot;#{type}; charset=utf-8&quot;</span> <span class="p">}</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="nx">content</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Return a 404 to the HTTP response.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">notFound</span> <span class="o">=</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">404</span><span class="p">,</span> <span class="p">{}</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s1">&#39;Not found.&#39;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>An asynchronous version of <code>forEach</code>. Calls <code>callback</code> with no
arguments once it's done running <code>f</code> for every item in <code>list</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">asyncEach</span> <span class="o">=</span> <span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">cb</span> <span class="o">=</span> <span class="nx">err</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">()</span> <span class="o">-&gt;</span>
        <span class="nx">i</span><span class="o">--</span>
        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="nx">callback</span> <span class="nx">ok</span>
    <span class="nx">f</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">list</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Converts a <code>RegExp.match</code>-style iterator into a regular list.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">toList</span> <span class="o">=</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">el</span> <span class="k">while</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">f</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Remove the extension from the file name, while keeping the directory
structure. Optionally specify which extension to remove (<code>ext</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">stripExt</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">ext</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">ext</span> <span class="o">or</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
    <span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">ext</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Replace all the occurences of <code>rule</code> in <code>string</code> with the result of
calling <code>f</code>. This is similar to the built-in Javascript function
<code>String.replace</code>, except <code>f</code> is asynchronous.</p>

<p><code>callback</code> is called with the resulting string on success.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">asyncReplace</span> <span class="o">=</span> <span class="p">(</span><span class="nx">string</span><span class="p">,</span> <span class="nx">rule</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">matches</span> <span class="o">=</span> <span class="nx">toList</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">rule</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">string</span>
    <span class="k">return</span> <span class="nx">callback</span> <span class="nx">ok</span><span class="p">,</span> <span class="nx">string</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">length</span>

    <span class="nx">replacements</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nx">each</span> <span class="o">=</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">f</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nx">replacements</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">content</span>
            <span class="nx">cb</span> <span class="nx">ok</span>

    <span class="nx">asyncEach</span> <span class="nx">matches</span><span class="p">,</span> <span class="nx">each</span><span class="p">,</span> <span class="nx">err</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">()</span> <span class="o">-&gt;</span>
        <span class="nx">callback</span> <span class="nx">ok</span><span class="p">,</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">rule</span><span class="p">,</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nx">replacements</span><span class="p">[</span><span class="nx">str</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>This function is similar to the Node.js <code>child_process.exec</code>, except
it also allows the caller to specify a string, <code>input</code> to be passed
to stdin, and also the working directory in which the subprocess
will be started. Logs stderr and returns a <code>callback</code> with the
contents of stdout.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">child_process</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;child_process&#39;</span>

<span class="nx">exec</span> <span class="o">=</span> <span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">cwd</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">callback</span>
        <span class="p">[</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">cwd</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">cwd</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">]</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">callback</span>
        <span class="p">[</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">input</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">input</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">]</span>

    <span class="p">[</span><span class="nx">arg</span><span class="p">,</span> <span class="nx">args</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">command</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39; &#39;</span>

    <span class="nx">proc</span> <span class="o">=</span> <span class="nx">child_process</span><span class="p">.</span><span class="nx">spawn</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="p">{</span> <span class="nv">cwd: </span><span class="nx">cwd</span> <span class="p">}</span>
    <span class="k">if</span> <span class="nx">input</span>
        <span class="nx">proc</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">write</span> <span class="nx">input</span>
        <span class="nx">proc</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

    <span class="nx">stdout</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">stderr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">proc</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">stdout</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span>
    <span class="nx">proc</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">stderr</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span>
    <span class="nx">proc</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">log</span> <span class="nx">stderr</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nx">stderr</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">callback</span> <span class="nx">ok</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h2>Start</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;http&#39;</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">server</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">)</span>
<span class="nx">log</span> <span class="s2">&quot;Barista development server listening on http://localhost:#{PORT}/&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 